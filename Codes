package org.example.service;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.example.dto.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;

import java.util.*;
import java.util.stream.Collectors;

@Service
public class DataService {

    @Autowired
    private WebClient.Builder webClientBuilder;

    @Value("${api.auth.dynamic-auth}")
    private String dynamicAuth;

    private final String authUrl = "https://api-int.staging.echonet/oauth2/v1/token?grant_type=client_credentials";
    private final String financeUrl = "https://api-int.staging.echonet/ce-third-parties/v2/batch-export?type=FinanceCH";
    private final String kycUrl = "https://api-int.staging.echonet/ce-third-parties/v2/entities/kyc?ptyId=69";

    public List<MergedEntity> fetchAndMergeData() {
        List<MergedEntity> mergedList = new ArrayList<>();

        try {
            // Step 1: Fetch Bearer Token
            String token = fetchAuthToken();
            if (token == null) return mergedList;

            // Step 2: Call Finance API
            File1Root financeRoot = fetchFinanceData(token);
            if (financeRoot == null || financeRoot.getResults() == null) return mergedList;

            // Step 3: Call KYC API
            File2Root kycRoot = fetchKycData(token);
            if (kycRoot == null || kycRoot.getResults() == null) return mergedList;

            // Step 4: Merge Data based on kycId
            mergedList = financeRoot.getResults().stream()
                    .map(File1Result::getEntity)
                    .filter(entity -> entity.getIdentifiers() != null && entity.getIdentifiers().getKycId() != null)
                    .flatMap(financeEntity -> {
                        Integer financeKycId = financeEntity.getIdentifiers().getKycId();

                        return kycRoot.getResults().stream()
                                .filter(kycResult -> kycResult.getIdentifiers().stream()
                                        .anyMatch(kid -> financeKycId.equals(kid.getKycId())))
                                .map(matchedKyc -> {
                                    KycData kycData = matchedKyc.getKycData();

                                    return new MergedEntity(
                                            Collections.singletonList(financeEntity.getIdentifiers()),
                                            financeEntity.getBusinessAddress(),
                                            kycData.getKycSites(),
                                            kycData.getKycSegment(),
                                            kycData.getRiskIndustry()
                                    );
                                });
                    })
                    .collect(Collectors.toList());

        } catch (Exception e) {
            System.err.println("Error during data merge: " + e.getMessage());
            e.printStackTrace();
        }

        return mergedList;
    }

    private String fetchAuthToken() {
        try {
            String response = webClientBuilder.build()
                    .post()
                    .uri(authUrl)
                    .header(HttpHeaders.ACCEPT, "*/*;version=gamma")
                    .header(HttpHeaders.AUTHORIZATION, dynamicAuth)
                    .retrieve()
                    .bodyToMono(String.class)
                    .block();

            JsonNode json = new ObjectMapper().readTree(response);
            return json.has("access_token") ? json.get("access_token").asText() : null;
        } catch (Exception e) {
            System.err.println("Error fetching token: " + e.getMessage());
            return null;
        }
    }

    private File1Root fetchFinanceData(String token) {
        try {
            return webClientBuilder.build()
                    .get()
                    .uri(financeUrl)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
                    .retrieve()
                    .bodyToMono(File1Root.class)
                    .block();
        } catch (Exception e) {
            System.err.println("Error fetching Finance data: " + e.getMessage());
            return null;
        }
    }

    private File2Root fetchKycData(String token) {
        try {
            return webClientBuilder.build()
                    .get()
                    .uri(kycUrl)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
                    .retrieve()
                    .bodyToMono(File2Root.class)
                    .block();
        } catch (Exception e) {
            System.err.println("Error fetching KYC data: " + e.getMessage());
            return null;
        }
    }
}
