package org.example.service;

import org.example.model.File1Root;
import org.example.model.File2Root;
import org.example.model.MergedEntity;
import org.example.model.File1Result;
import org.example.model.File2Result;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;

import java.io.IOException;
import java.net.InetAddress;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Optional;

@Service
public class DataService {

    private final WebClient webClient;
    private static final Logger logger = LoggerFactory.getLogger(DataService.class);
    private static final int MAX_RETRIES = 3;

    @Value("${api.finance.url}")
    private String financeUrl;

    @Value("${api.kyc.url}")
    private String kycUrl;

    @Autowired
    public DataService(WebClient webClient) {
        this.webClient = webClient; // Injecting the WebClient bean
    }

    public List<MergedEntity> fetchMergedData() {
        // Check DNS resolution
        if (!checkDnsResolution("api-int.staging.echonet")) {
            return Collections.emptyList(); // Exit if DNS resolution fails
        }

        // Fetch data from APIs
        File1Root financeData = fetch(financeUrl, File1Root.class);
        File2Root kycData = fetch(kycUrl, File2Root.class);

        // Merge the fetched data
        return mergeData(financeData, kycData);
    }

    private boolean checkDnsResolution(String hostname) {
        try {
            InetAddress address = InetAddress.getByName(hostname);
            logger.info("Resolved hostname: {}", address.getHostAddress());
            return true;
        } catch (IOException e) {
            logger.error("Hostname could not be resolved: {}", hostname, e);
            return false;
        }
    }

    private <T> T fetch(String url, Class<T> clazz) {
        int attempts = 0;
        T result = null;

        while (attempts < MAX_RETRIES) {
            try {
                result = webClient.get()
                        .uri(url)
                        .header("Accept", "*/*;version=gamma") // Add the Accept header
                        .retrieve()
                        .bodyToMono(clazz)
                        .block();
                logger.info("Successfully fetched data from {}", url);
                return result; // Return the result if successful
            } catch (Exception e) {
                attempts++;
                logger.warn("Attempt {} failed for URL {}: {}", attempts, url, e.getMessage());
                if (attempts >= MAX_RETRIES) {
                    logger.error("Max retries reached for URL {}. Giving up on API call.", url);
                }
            }
        }
        return result; // Return null if all attempts fail
    }

    private List<MergedEntity> mergeData(File1Root financeData, File2Root kycData) {
        if (financeData == null || kycData == null) {
            logger.warn("One or both data sources are null. Returning empty list.");
            return Collections.emptyList();
        }

        List<MergedEntity> merged = new ArrayList<>();

        for (File1Result financeResult : financeData.getResults()) {
            if (financeResult.getEntity() == null || financeResult.getEntity().getIdentifiers() == null) {
                logger.warn("Skipping finance result with null entity or identifiers.");
                continue;
            }

            Identifiers financeId = financeResult.getEntity().getIdentifiers();
            Optional<File2Result> match = kycData.getResults().stream()
                    .filter(kyc -> kyc.getIdentifiers() != null && !kyc.getIdentifiers().isEmpty() &&
                            financeId.getPtyId().equals(kyc.getIdentifiers().get(0).getPtyId()))
                    .findFirst();

            match.ifPresent(kyc -> {
                MergedEntity mergedEntity = new MergedEntity();
                mergedEntity.setIdentifiers(Collections.singletonList(financeId));
                mergedEntity.setBusinessAddress(financeResult.getEntity().getBusinessAddress());

                KycData kycDataObj = kyc.getKycData();
                if (kycDataObj != null) {
                    mergedEntity.setKycSites(kycDataObj.getKycSites());
                    mergedEntity.setKycSegment(kycDataObj.getKycSegment());
                    mergedEntity.setRiskIndustry(kycDataObj.getRiskIndustry());
                }

                merged.add(mergedEntity);
            });
        }

        logger.info("Merged {} entities from finance and KYC data.", merged.size());
        return merged;
    }
}
