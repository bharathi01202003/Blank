public void saveMergedEntitiesToH2() {
    List<MergedEntity> entities = getMergedEntities();

    for (MergedEntity entity : entities) {
        if (entity.getIdentifiers() == null || entity.getIdentifiers().isEmpty()) continue;

        Identifiers id = entity.getIdentifiers().get(0);
        RegistrationAddress reg = entity.getRegistrationAddress();
        KycSites site = entity.getKycSites() != null && !entity.getKycSites().isEmpty()
                ? entity.getKycSites().get(0) : null;

        String ric = "";
        if (entity.getRiskIndustry() != null && !entity.getRiskIndustry().isEmpty()) {
            ric = entity.getRiskIndustry().stream()
                    .map(ri -> safe(ri.getRiskIndustryCode()) + "-" + safe(ri.getRiskIndustryDescription()))
                    .collect(Collectors.joining(","));
        }

        MergedEntityRecord record = MergedEntityRecord.builder()
                .crdsCode(safe(id.getCrdsCode()))
                .registrationAddress(reg != null
                        ? Stream.of(reg.getLine1(), reg.getLine2(), reg.getCity(), reg.getState(), reg.getZipCode())
                                .filter(s -> s != null && !s.isBlank())
                                .map(this::safe)
                                .collect(Collectors.joining(" "))
                        : "")
                .country(reg != null ? safe(reg.getCountry()) : "")
                .siteName(site != null ? safe(site.getSiteName()) : "")
                .siteCountry(site != null ? safe(site.getSiteCountry()) : "")
                .siteStatus(site != null ? safe(site.getSiteStatus()) : "")
                .kycSegment(safe(entity.getKycSegment()))
                .riskIndustryCodes(ric)
                .build();

        try {
            recordRepository.save(record);
        } catch (Exception e) {
            logger.error("Failed to save record for crdsCode: {}", id.getCrdsCode(), e);
        }
    }

    logger.info("All merged entities saved to H2 database.");
}
