package org.example.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.example.dto.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;

import java.util.*;
import java.util.stream.Collectors;

@Service
public class DataService {

    @Autowired
    private WebClient.Builder webClientBuilder;

    private final String authUrl = "https://api-uat.staging.echonet/oauth2/v1/token?grant_type=client_credentials";
    private final String financeUrl = "https://api-int.staging.echonet/ce-third-parties/v2/batch-export?type=FinanceCH";
    private final String kycUrl = "https://api-int.staging.echonet/ce-third-parties/v2/entities/kyc?ptyId=69";

    private final String clientId = "yourClientId";

    public List<MergedEntity> fetchAndMergeData() {
        String token = fetchAuthToken();
        if (token == null) return Collections.emptyList();

        File1Root financeRoot = fetchFinanceData(token);
        File2Root kycRoot = fetchKycData(token);
        if (financeRoot == null || kycRoot == null) return Collections.emptyList();

        return financeRoot.getResults().stream()
                .map(File1Result::getEntity)
                .filter(entity -> entity.getIdentifiers() != null && entity.getIdentifiers().getKycId() != null)
                .flatMap(finEntity -> {
                    Integer financeKycId = finEntity.getIdentifiers().getKycId();

                    return kycRoot.getResults().stream()
                            .filter(kycResult ->
                                    kycResult.getIdentifiers().stream()
                                            .anyMatch(kid -> kid.getKycId().equals(financeKycId)))
                            .map(kycResult -> {
                                KycData kycData = kycResult.getKycData();

                                return new MergedEntity(
                                        Collections.singletonList(finEntity.getIdentifiers()),
                                        finEntity.getBusinessAddress(),
                                        kycData.getKycSites(),
                                        kycData.getKycSegment(),
                                        kycData.getRiskIndustry()
                                );
                            });
                })
                .collect(Collectors.toList());
    }

    private String fetchAuthToken() {
        try {
            String requestBody = "client_id=" + clientId;

            String response = webClientBuilder.build()
                    .post()
                    .uri(authUrl)
                    .header(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_FORM_URLENCODED_VALUE)
                    .bodyValue(requestBody)
                    .retrieve()
                    .bodyToMono(String.class)
                    .block();

            return new ObjectMapper().readTree(response).get("access_token").asText();
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    private File1Root fetchFinanceData(String token) {
        try {
            return webClientBuilder.build()
                    .get()
                    .uri(financeUrl)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
                    .retrieve()
                    .bodyToMono(File1Root.class)
                    .block();
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    private File2Root fetchKycData(String token) {
        try {
            return webClientBuilder.build()
                    .get()
                    .uri(kycUrl)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
                    .retrieve()
                    .bodyToMono(File2Root.class)
                    .block();
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }
}
