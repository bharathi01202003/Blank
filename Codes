package org.example.service;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;

import java.util.Map;

@Service
public class AuthService {

    private final WebClient webClient;

    @Value("${auth.token.url}")
    private String tokenUrl;

    @Value("${auth.basic.token}")
    private String basicToken;

    public AuthService(WebClient.Builder builder) {
        this.webClient = builder.build();
    }

    public String fetchToken() {
        Map<String, Object> response = webClient.post()
                .uri(tokenUrl)
                .header("Accept", "*/*;version=gamma")
                .header("Authorization", "Basic " + basicToken)
                .retrieve()
                .bodyToMono(new ParameterizedTypeReference<Map<String, Object>>() {})
                .block();

        if (response != null && response.containsKey("access_token")) {
            return (String) response.get("access_token");
        } else {
            throw new RuntimeException("Token fetch failed or response is empty");
        }
    }
}

package org.example.service;

import org.example.model.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;

import java.util.*;

@Service
public class DataService {

    private final WebClient webClient;
    private final AuthService authService;
    private static final Logger logger = LoggerFactory.getLogger(DataService.class);

    @Value("${api.finance.url}")
    private String financeUrl;

    @Value("${api.kyc.url}")
    private String kycUrl;

    public DataService(WebClient.Builder builder, AuthService authService) {
        this.webClient = builder.build();
        this.authService = authService;
    }

    public List<MergedEntity> fetchMergedData() {
        String token = authService.fetchToken();

        File1Root financeData = fetch(financeUrl, File1Root.class, token);
        File2Root kycData = fetch(kycUrl, File2Root.class, token);

        if (financeData == null || kycData == null) return Collections.emptyList();

        List<MergedEntity> result = new ArrayList<>();

        for (File1Result finance : financeData.getResults()) {
            if (finance.getEntity() == null || finance.getEntity().getIdentifiers() == null) continue;

            Identifiers financeId = finance.getEntity().getIdentifiers();
            Optional<File2Result> matched = kycData.getResults().stream()
                    .filter(kyc -> kyc.getIdentifiers() != null && !kyc.getIdentifiers().isEmpty() &&
                            financeId.getPtyId().equals(kyc.getIdentifiers().get(0).getPtyId()))
                    .findFirst();

            matched.ifPresent(kyc -> {
                MergedEntity merged = new MergedEntity();
                merged.setIdentifiers(Collections.singletonList(financeId));
                merged.setBusinessAddress(finance.getEntity().getBusinessAddress());

                if (kyc.getKycData() != null) {
                    merged.setKycSites(kyc.getKycData().getKycSites());
                    merged.setKycSegment(kyc.getKycData().getKycSegment());
                    merged.setRiskIndustry(kyc.getKycData().getRiskIndustry());
                }

                result.add(merged);
            });
        }

        return result;
    }

    private <T> T fetch(String url, Class<T> clazz, String token) {
        try {
            return webClient.get()
                    .uri(url)
                    .header("Accept", "*/*;version=gamma")
                    .header("Authorization", "Bearer " + token)
                    .retrieve()
                    .bodyToMono(clazz)
                    .block();
        } catch (Exception e) {
            logger.error("Failed to fetch from {}: {}", url, e.getMessage());
            return null;
        }
    }
}




package org.example.controller;

import org.example.model.MergedEntity;
import org.example.service.DataService;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

@RestController
public class MergerController {

    private final DataService dataService;

    public MergerController(DataService dataService) {
        this.dataService = dataService;
    }

    @GetMapping("/merged-results")
    public List<MergedEntity> getMerged() {
        return dataService.fetchMergedData();
    }
}



